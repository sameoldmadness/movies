<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Movies locations</title>
  <style>
    #content {
      width: 640px;
      text-align: center;
    }

    #map {
      height: 480px;
      width: 100%;
    }

    input[type="range"] {
      width: 100%;
      margin: 2em 0;
    }
  </style>
</head>
<body>
    <div id="content">
      <div id="map"></div>
      <input type="range" min="1930" max="2020" step="1" value="1989">
      <span id="year"></span>
    </div>

    <script>
      const rangeEl = document.querySelector('input[type="range"]');
      const yearEl = document.querySelector('#year');
      const mapEl = document.querySelector('#map');

      const getLocations = memoize(fetchLocations);
      const getGeocode = memoize(fetchGeocode);
      const mapsReadyDeferred = new Deferred();
      const mapsReady = mapsReadyDeferred.promise;

      let markers = [];

      rangeEl.addEventListener('input', debounce(onRangeUpdate, 500));
      rangeEl.addEventListener('input', () => yearEl.textContent = rangeEl.value);
      fireEvent('input', rangeEl);

      function onRangeUpdate() {
        const year = rangeEl.value;

        markers.forEach(marker => marker.setMap(null));
        markers = [];

        getLocations()
          .then(xs => xs.filter(x => x.releaseYear === year))
          .then(locations => Promise.all(locations.map(location => {
            const address = location.locations;

            if (address === null) return;

            return getGeocode(address).then(res => {
              if (res === '') return;

              const position = {
                lat: res.geometry.location.lat(),
                lng: res.geometry.location.lng()
              };

              mapsReady.then(map => {
                markers.push(new google.maps.Marker({
                  position,
                  map,
                  title: location.title
                }));
              })
            });
          })));
      }

      function debounce(fn, delay) {
        let start;

        return (...args) => {
          const now = Date.now();

          if (now - start < delay) return;

          start = now;
          fn(...args);
        };
      }

      function fireEvent(name, node) {
        const event = document.createEvent("HTMLEvents");

        event.initEvent(name, false, true);
        node.dispatchEvent(event);
      }

      function memoize(fn) {
        const cache = new Map();

        return (...args) => {
          const key = JSON.stringify(args)
          if (cache.has(key)) {
            return Promise.resolve(cache.get(key));
          }

          return fn(...args).then(res => {
            cache.set(key, res);

            return res;
          });
        }
      }

      function fetchLocations() {
        return fetch('data/film-locations.json')
          .then(res => res.json())
          .then(locationsFromJson);
      }

      function locationsFromJson(json) {
        const columns = json.meta.view.columns.map(x => x.name);
            
        return json.data.map(row => {
          return columns.reduce((location, name, index) => {
            location[camelize(name)] = row[index];

            return location;
          }, {});
        });
      }

      function ucFirst(str) {
        return str[0].toUpperCase() + str.slice(1);
      }

      function lcFirst(str) {
        return str[0].toLowerCase() + str.slice(1);
      }

      function camelize(str) {
        return lcFirst(str
          .replace(/\s/g, '')
          .split('_')
          .map(ucFirst)
          .join(''));
      }

      /** 
       * @copyright wbinnssmith 
       * @link https://github.com/wbinnssmith/promise-deferred/blob/master/index.js
       */
      function Deferred() {
        this.promise = new Promise((resolve, reject) => {
          this.resolve = resolve;
          this.reject = reject;
        });
      };

      function initMap() {
        const map = new google.maps.Map(mapEl, {
          center: {lat: 37.8008245, lng: -122.4533048},
          zoom: 12
        });

        mapsReadyDeferred.resolve(map);
      }

      function fetchGeocode(address) {
        return new Promise((resolve, reject) => {
          mapsReady.then(() => {
            const geocoder = new google.maps.Geocoder();

            geocoder.geocode({address}, (results, status) => {
              if (status === google.maps.GeocoderStatus.OK) {
                resolve(results[0]);
              } else {
                resolve('');
              }
            });
          });
        });
      }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCRaKUp6sm9VfGKfEimJhMg5aNIykXyW-Y&callback=initMap"
  type="text/javascript"></script>
</body>
</html>